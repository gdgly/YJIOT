<!DOCTYPE html>
<html>
<head>
<title>商户消费详情</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<META HTTP-EQUIV="pragma" CONTENT="no-cache" />
<META HTTP-EQUIV="Cache-Control" CONTENT="no-cache, must-revalidate" />
<link href="../../compontents/bootstarp/css/bootstrap-UI.css.css"
	rel="stylesheet" media="screen">
<link
	href="../../compontents/bootstrap-datetimepicker-master/css/bootstrap-datetimepicker.min.css"
	rel="stylesheet" media="screen">

<link
	href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"
	rel="stylesheet" />
<link href="../../compontents/iot/css/table.css" rel="stylesheet" />
<script
	src="https://cdn.staticfile.org/flat-ui/2.3.0/js/vendor/jquery.min.js"></script>
<script src="https://cdn.staticfile.org/flat-ui/2.3.0/js/flat-ui.min.js"></script>
<script src="../../compontents/bootstarp/js/bootstrap-table.js"></script>
	<script src="../../compontents/bootstarp/js/tableExport.js"></script>

<script
	src="https://cdn.bootcss.com/bootstrap-table/1.11.1/locale/bootstrap-table-zh-CN.min.js"></script>
<script type="text/javascript"
	src="../../compontents/bootstrap-datetimepicker-master/js/bootstrap-datetimepicker.js"
	charset="UTF-8"></script>
<script src="../../compontents/iot/js/api.js"></script>
<style type="text/css">
textarea {
	resize: none;
	overflow: hidden;
}

body {
	font-family: "华文细黑";
	width: 100%;
	height: auto;
	background: #f7f7f7;
	margin-left: 30px;
	padding-right: 50px;
}
</style>
</head>
<body>

	<!-- /消费详情 -->
	<div class="modal fade myModal" id="myModal" tabindex="-1"
		role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<div id="modalDialog" class="modal-dialog" style="width: 1200px">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-hidden="true">×</button>
					<h4 class="modal-title" id="myModalLabel">商户消费详情</h4>
				</div>
				<div class="modal-body">
					<table id="tableData_merchant">
						<tfoot>
							<tr>
								<td></td>
								<td></td>
								<td>总计:<span style="color: red" id='sums_merchant'></span></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
								<td></td>
							<tr>
						</tfoot>
					</table>
					<div style=" clear:both"></div>
				</div>
			</div>
			<!-- /.modal-content -->
		</div>
		<!-- /.modal-dialog -->
	</div>

	<div>
		<h4 style="margin-left: 15px;margin-bottom: -15px;margin-top: 2px">商户收入报表</h4>
		<hr
			style="height:1px;border:none;border-top:3px solid #028cfd;margin-bottom: 15px" />
		<div style=""></div>
		<div class="input-group col-md-2" style="float: left;">
			<span class="input-group-addon" style="width:20px; height: 34px;">商户名称</span>
			<select style="width:330x;height:35px" id="merchant">
				<option value="merchantAll">所有商户</option>
			</select>
		</div>
		<div class="input-group col-md-1"
			style=" float: left;margin-left: 5px;margin-bottom: 10px">
			<span class="input-group-addon" style="height: 34px;">开始时间</span>
			<div class="controls input-append date form_datetime"
				data-date-format="yyyy-mm-dd" data-link-field="dtp_input1"
				style="height: 10px;max-height: 10px;">
				<input name="beginDate " id="beginDate" type="text"
					style="width:142px;height:34px" value="" readonly> <span
					class="add-on"><i class="icon-remove"></i></span> <span
					class="add-on"><i class="icon-th"></i></span>
			</div>
		</div>
		<div class="input-group col-md-1"
			style=" float: left;margin-left: 5px">
			<span class="input-group-addon" style="height: 35px;">结束时间</span>
			<div class="controls input-append date form_datetime"
				data-date-format="yyyy-mm-dd" data-link-field="dtp_input1"
				style="height: 10px;max-height: 10px;">
				<input name="endDate " id="endDate" type="text"
					style="width:142px;height:35px" value="" readonly> <span
					class="add-on"><i class="icon-remove"></i></span> <span
					class="add-on"><i class="icon-th"></i></span>
			</div>
		</div>
					<button class="btn btn-primary "
				style="float:left; margin-left: 5px ;" onclick="refreshTableData()">统计查询</button>
						<button type="button" style="float:left;margin-left:10px" id="download" 
				id="btn_download" class="btn btn-primary"
				onClick="$('#tableData').tableExport({ type: 'excel', escape: 'false' })">数据导出</button>
	
		<table id="tableData">

			<tfoot>
				<tr>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td>总计:<span style="color: red" id='sumConsumption'></span></td>
					<td></td>
					<td></td>
				<tr>
			</tfoot>
		</table>
	</div>
</body>
<script type="text/javascript">
	$('.form_datetime').datetimepicker({
		language : 'cn',
		minView : "month", //选择日期后，不会再跳转去选择时分秒 
		format : 'yyyy-mm-dd',
		weekStart : 1,
		todayBtn : true,
		autoclose : 1,
		todayHighlight : 1,
		startView : 2,
		forceParse : 0,
		showMeridian : 1
	});
</script>
<script type="text/javascript">
	//所有商户
	function selMerchantAll() {
		var data = {};
		$dict.selMerchantAll(data, function(ret) {
			//$("#merchant").empty();
			var ret = ret.merchantList;
			for (i in ret) {
				$("#merchant").append("<option class='' value=" + ret[i].merchantCode + ">" + ret[i].name + "</option>");
			}
		}, function() {})
	}
</script>
<script>
	var d = new Date(); //获取系统当前时间
	var myDate = d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate() + ' ' + d.getHours() + ':' + d.getMinutes() + ':' + d.getSeconds();
	myDate = myDate.substr(0, 9);

	var beginDate = myDate;
	var endDate = myDate;
		$('#beginDate').val(myDate);
	$('#endDate').val(myDate);
	//初始化信息
	function initTable() {
		$api.ui_openLoading('提示', '消费信息加载中，请耐心等待......');
		window.setTimeout(function() {
			$api.ui_closeLoading();
		}, 500);
		var sumConsumption = 0;

		var data = {
			"beginDate" : beginDate,
			"endDate" : endDate
		};
		console.log(data);

		$query.consumeMerchantQuery(data,
			function(ret) {
				var obj = ret.data;
				for (i in obj) {
					var consumption = $api.roundNumber(obj[i]['费用发生（￥）'], 2);
					sumConsumption = sumConsumption + consumption;
				}
				sumConsumption = $api.roundNumber(sumConsumption, 2);
				$('#sumConsumption').text(sumConsumption);
				$("#tableData").bootstrapTable('load', data);
				//bootstrap-Table获取数据
				$table = $('#tableData').bootstrapTable({
					data : obj, //最终的JSON数据放在这里
					height : $(window).height() - 100,
					striped : true,
					pagination : true,
					pageNumber : 1,
					pageSize : 10,
					pageList : [ 10, 50, 100, 1000 ],
					search : true,
					sidePagination : "client",
					minimunCountColumns : 2,
					columns : [
						{
							title : '编号',
							formatter : function(value, row, index) {
								return index + 1;
							}
						},
						{
							field : '商户类型',
							title : '商户类型	',
							align : 'center',
							sortable : true
						},
						{
							field : '商户名称',
							title : '商户名称',
							align : 'center',
							sortable : true
						},
						{
							field : '地址',
							title : '地址',
							align : 'center',
							sortable : true
						},
						{
							field : '费用发生（￥）',
							title : '费用发生（￥）',
							align : 'center',
							sortable : true
						},
						{
							field : '销售经理',
							title : '销售经理',
							align : 'center',
							sortable : true
						},
						{
							field : 'operate',
							title : '操作',
							align : 'center',
							formatter : function(value, row, index) {
								var c = '<button type="button" class="btn btn-success  btn-sm" style="margin-right:15px;" data-toggle="modal" data-target="#myModal" onclick="merchant(\'' + row.merchantCode + '\')">消费详情</button>';
								return c;
							}
						}
					],
					formatNoMatches : function() {
						return "没有相关的匹配结果";
					},
					formatLoadingMessage : function() {
						return "";
					},
				});
			},
			function() {
				$api.ui_openAlert('查询提示', '商户收入信息加载失败');
			});

	}

	/*  刷新用户信息 */
	function refreshTableData() {
		beginDate = $("#beginDate").val();
		endDate = $("#endDate").val();
		var merchantCode = $("#merchant").val();
		var sumConsumption = 0;
		if ($api.isNull(beginDate)) {
			beginDate = myDate;
		}
		if ($api.isNull(endDate)) {
			endDate = myDate;
		}
		var data = {}
		if (merchantCode != 'merchantAll') {
			data = {
				"beginDate" : beginDate,
				"endDate" : endDate,
				"merchantCode" : merchantCode
			};
		} else {
			data = {
				"beginDate" : beginDate,
				"endDate" : endDate,
			};
		}
		$query.consumeMerchantQuery(data,
			function(ret) {
				var data = ret.data; //要传入table的数据值
				$('#sumConsumption').text(sumConsumption);

				if (!$api.isNull(data)) {
					for (i in data) {
						var consumption = $api.roundNumber(data[i]['费用发生（￥）'], 2);
						sumConsumption = sumConsumption + consumption;
					}
					sumConsumption = $api.roundNumber(sumConsumption, 2);
					$('#sumConsumption').text(sumConsumption);
					$("#tableData").bootstrapTable('load', data);

				} else {
					var data = [];
					$('#sumConsumption').text(0);
					$("#tableData").bootstrapTable('load', data);
				}
			},


			function() {
				$api.ui_openAlert('查询提示', '没有相关的匹配结果');
				var data = [];
				$('#sumConsumption').text(0);
				$("#tableData").bootstrapTable('load', data);
			});


	}
</script>
<script type="text/javascript">
	function merchant(data) {
		var sums_merchant = 0;
		var data = {
			"beginDate" : beginDate,
			"endDate" : endDate,
			"merchantCode" : data
		};
		$query.consumeDetailQuery(data,

			function(ret) {
				var obj = ret.data;
				for (i in obj) {
					var merchant = $api.roundNumber(obj[i]['消费金额（￥）'], 2);
					sums_merchant = sums_merchant + merchant;
				}
				sums_merchant = $api.roundNumber(sums_merchant, 2);
				$('#sums_merchant').text(sums_merchant);
				$("#tableData_merchant").bootstrapTable('load', obj);
				//bootstrap-Table获取数据
				$table = $('#tableData_merchant').bootstrapTable({
					data : obj, //最终的JSON数据放在这里
					height : $(window).height() - 100,
					striped : true,
					pagination : true,
					pageNumber : 1,
					pageSize : 100,
					pageList : [ 5, 10, 20, 50, 100 ],
					sidePagination : "client",
					minimunCountColumns : 2,
					columns : [
						{
							title : '编号',
							formatter : function(value, row, index) {
								return index + 1;
							}
						},
						{
							field : '商户类型',
							title : '商户类型',
							align : 'center',
							sortable : true
						},
						{
							field : '消费金额（￥）',
							title : '消费金额（￥）',
							align : 'center',
							sortable : true
						},
						{
							field : '付款状态',
							title : '付款状态',
							align : 'center',
							sortable : true
						},
						{
							field : '消费时间',
							title : '消费时间',
							align : 'center',
							sortable : true
						},
						{
							field : '设备MAC',
							title : '设备MAC',
							align : 'center',
							sortable : true
						},
						{
							field : '消费者',
							title : '消费者',
							align : 'center',
							sortable : true
						},
						{
							field : '商户名称',
							title : '商户名称',
							align : 'center',
							sortable : true
						},
						{
							field : '消费地点',
							title : '消费地点',
							align : 'center',
							sortable : true
						},
						{
							field : '支付类型',
							title : '支付类型',
							align : 'center',
							sortable : true
						},
					],
					formatNoMatches : function() {
						return "没有相关的匹配结果";
					},
					formatLoadingMessage : function() {
						return "";
					},
				});
			},
			function() {
				$api.ui_openAlert('查询提示', '消费信息加载失败');
				var data = [];
				$("#tableData").bootstrapTable('load', data);
				$('#sums_merchant').text(0);
			});

	}
</script>
<script>
	$(function() {
		$api.Initialize();
		initTable();
		selMerchantAll();
	});
</script>
</html>



