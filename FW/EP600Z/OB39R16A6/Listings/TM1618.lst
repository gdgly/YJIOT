C51 COMPILER V9.52.0.0   TM1618                                                            08/31/2017 13:51:53 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE TM1618
OBJECT MODULE PLACED IN .\Objects\TM1618.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE USER\TM1618\TM1618.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(.\USER\IIC;.\
                    -USER\UART;.\USER\TM1618;.\USER\Sensor;.\USER;.\USER\PWM;.\USER\DC_MOTOR;.\USER\timer;.\USER\inc;.\USER\EXINT;.\USER\touc
                    -h_key;.\USER\SYS_RUN;.\USER\step_motor;.\USER\BUZZER;.\USER\UART;.\USER\common;.\USER\lib;.\USER\UV;.\USER\ION;.\USER\CO
                    -ST;.\USER\EEPROM) DEBUG OBJECTEXTEND PRINT(.\Listings\TM1618.lst) TABS(2) OBJECT(.\Objects\TM1618.obj)

line level    source

   1          #include "TM1618.h"
   2          #include "sensor.h"
   3          
   4          //buff[0]-buff[9]分别表示显示0-9，buff[10]表示数码管灭
   5          const unsigned char led_display_buff[11][2] = {
   6           //0-4
   7          {0x1F,0x08},{0x06,0x00},{0x1B,0x10},{0x0F,0x10},{0x06,0x18},
   8          //5-9
   9          {0x0D,0x18},{0x1C,0x18},{0x07,0x00},{0x1F,0x18},{0x07,0x18},
  10          //灭
  11          {0x00,0x00}
  12          
  13          
  14          };
  15          
  16          static void mydelay(int num)
  17          {
  18   1          while(num--);
  19   1      }
  20            
  21          void TM1618_Pin_Config(void)
  22          {
  23   1          //PIN设置为推挽输出，PxM0对应的位置1，PxM1对应的位置0
  24   1          P1M0 |= ((1 << 3) | (1 << 4) | (1 << 5));
  25   1          P1M1 &= ~((1 << 3) | (1 << 4) | (1 << 5));
  26   1          TM1618_STB_PIN = 1;
  27   1          TM1618_CLK_PIN = 1;
  28   1          TM1618_DIO_PIN = 1;
  29   1        
  30   1      }
  31          
  32          
  33          
  34          //刚上电后设置显示模式5位7段，把TM1618的显示寄存器0xC0-0xCD全部写0
  35          void TM1618_Init(void)
  36          {
  37   1          TM1618_Pin_Config();
  38   1          TM1618_SetMode();
  39   1          TM1618_Clear_Framebuff();
  40   1          TM1618_Display_On();
  41   1      }
  42          
  43          
  44          void TM1618_WriteOneByte(unsigned char senddata)
  45          {
  46   1          unsigned char i = 0;
  47   1          unsigned char tempdata = 0;
  48   1        
  49   1          tempdata = senddata;
  50   1          //TM1618_STB_PIN = 0;
  51   1        
  52   1          
C51 COMPILER V9.52.0.0   TM1618                                                            08/31/2017 13:51:53 PAGE 2   

  53   1          for(i = 0;i < 8;i++)
  54   1          {
  55   2              TM1618_CLK_PIN = 0;
  56   2              if(tempdata & 0x01)
  57   2              {
  58   3                  TM1618_DIO_PIN = 1;
  59   3              }
  60   2              else
  61   2              {
  62   3                  TM1618_DIO_PIN = 0;
  63   3              }
  64   2              //TM1618_CLK_PIN = 0;
  65   2              mydelay(1);
  66   2              TM1618_CLK_PIN = 1;
  67   2              mydelay(1);
  68   2              
  69   2              tempdata = tempdata >> 1;       
  70   2          }
  71   1          //TM1618_STB_PIN = 1;    
  72   1      }
  73          
  74          /*
  75          void TM1618_WriteBytes(const unsigned char *senddata,unsigned char num)
  76          {
  77              unsigned char i,j = 0;
  78              unsigned char tempdata = 0;
  79            
  80              //TM1618_STB_PIN = 0;
  81            
  82              for(j = 0;j < num;j++)
  83              {
  84                  tempdata = *(senddata + j);
  85                  for(i = 0;i < 8;i++)
  86                  {
  87                      TM1618_CLK_PIN = 0;
  88                      if(tempdata & 0x01)
  89                      {
  90                          TM1618_DIO_PIN = 1;
  91                      }
  92                      else
  93                      {
  94                          TM1618_DIO_PIN = 0;
  95                      }           
  96                      mydelay(2);
  97                      TM1618_CLK_PIN = 1;
  98                      mydelay(1);
  99                  
 100                      tempdata = tempdata >> 1;       
 101                  }
 102              }
 103              //TM1618_STB_PIN = 1;    
 104          }
 105          */
 106          
 107          //设置为5位7段模式
 108          void TM1618_SetMode(void)
 109          {
 110   1          TM1618_STB_PIN = 0;
 111   1          TM1618_WriteOneByte(TM1618_MODE_CMD);
 112   1          TM1618_STB_PIN = 1;
 113   1      }
 114          
C51 COMPILER V9.52.0.0   TM1618                                                            08/31/2017 13:51:53 PAGE 3   

 115          //设置数据命令
 116          void TM1618_SetDataMode(void)
 117          {
 118   1          TM1618_STB_PIN = 0;
 119   1          TM1618_WriteOneByte(TM1618_DATA_CMD);
 120   1          TM1618_STB_PIN = 1;
 121   1      }
 122          
 123          //往TM1618的显示寄存器中写数据
 124          void TM1618_WriteFrameRegister(unsigned char *displaybuff,unsigned char lednum)
 125          {
 126   1          unsigned char i,j = 0;
 127   1        
 128   1          TM1618_SetDataMode();
 129   1          mydelay(2);
 130   1          TM1618_STB_PIN = 0; 
 131   1          //设置数据传送寄存器首地址  
 132   1          TM1618_WriteOneByte(TM1618_SET_ADDR_CMD);
 133   1          for(i = 0;i < lednum;i++)
 134   1          {
 135   2              for(j = 0;j < 2;j++)
 136   2              {
 137   3                  TM1618_WriteOneByte(led_display_buff[displaybuff[i]][j]);
 138   3              }
 139   2              
 140   2          }  
 141   1          TM1618_STB_PIN = 1;
 142   1      }
 143          
 144          //把显示寄存器清零
 145          void TM1618_Clear_Framebuff(void)
 146          {
 147   1          unsigned char i = 0;
 148   1        
 149   1          TM1618_SetDataMode();
 150   1        
 151   1          TM1618_STB_PIN = 0;
 152   1          TM1618_WriteOneByte(TM1618_SET_ADDR_CMD);
 153   1          for(i = 0;i < 14;i++)
 154   1          {
 155   2              TM1618_WriteOneByte(0x00);
 156   2          }     
 157   1          TM1618_STB_PIN = 1;
 158   1        
 159   1      }
 160          
 161          void TM1618_Display_On(void)
 162          {
 163   1          TM1618_STB_PIN = 0;
 164   1          TM1618_WriteOneByte(TM1618_PULSE_WIDTH_10_16);
 165   1          TM1618_STB_PIN = 1;
 166   1      }
 167          
 168          /*
 169          void TM1618_Display_Off(void)
 170          {
 171              TM1618_STB_PIN = 0;
 172              TM1618_WriteOneByte(TM1618_OFF);
 173              TM1618_STB_PIN = 1;
 174          }
 175          */
 176          
C51 COMPILER V9.52.0.0   TM1618                                                            08/31/2017 13:51:53 PAGE 4   

 177          void TM1618_DispalyData(unsigned char sensor,float sensordata)
 178          {
 179   1          unsigned char j = 0;
 180   1          unsigned char displaybuff[3] = {0};
 181   1          unsigned int displaydata = 0;
 182   1          if(sensor == SENSOR_HCHO)
 183   1          {
 184   2              if(sensordata >= 10)
 185   2              {
 186   3                  displaydata = 999;         
 187   3              }
 188   2              else
 189   2              {
 190   3                  displaydata = (int)(sensordata * 100);
 191   3              }
 192   2      
 193   2          }
 194   1          else if(sensor == SENSOR_PM25)
 195   1          {
 196   2              if(sensordata >= 1000)
 197   2              {
 198   3                  displaydata = 999;
 199   3              }
 200   2              else
 201   2              {
 202   3                  displaydata = (int)sensordata;
 203   3              }
 204   2          }
 205   1          
 206   1      
 207   1          displaybuff[2] = displaydata / 100;
 208   1          displaybuff[1] = (displaydata % 100) / 10;
 209   1          displaybuff[0] = displaydata % 10;
 210   1          
 211   1          if(sensor == SENSOR_HCHO)
 212   1          {
 213   2      //        TM1618_WriteFrameRegister(displaybuff,1);
 214   2      //        //显示甲醛数据的时候要显示小数点
 215   2      //        LED1_DP_PIN = 1;
 216   2      //        mydelay(3);
 217   2      //        LED1_DP_PIN = 0;
 218   2      //        TM1618_WriteFrameRegister(displaybuff,1);
 219   2              
 220   2          }
 221   1          else if(sensor == SENSOR_PM25)
 222   1          {
 223   2      
 224   2          }
 225   1          
 226   1          TM1618_WriteFrameRegister(displaybuff,3);
 227   1          
 228   1          
 229   1      }
 230          
 231          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    511    ----
   CONSTANT SIZE    =      3    ----
   XDATA SIZE       =     22      17
   PDATA SIZE       =   ----    ----
C51 COMPILER V9.52.0.0   TM1618                                                            08/31/2017 13:51:53 PAGE 5   

   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
