C51 COMPILER V9.52.0.0   TIMER                                                             12/28/2017 10:57:51 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE TIMER
OBJECT MODULE PLACED IN .\Objects\timer.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\User\timer\timer.c OPTIMIZE(8,SPEED) BROWSE INCDIR(..\User;..\User\le
                    -d;..\User\touch;..\User\timer;..\User\inc) DEBUG OBJECTEXTEND PRINT(.\Listings\timer.lst) TABS(2) OBJECT(.\Objects\timer
                    -.obj)

line level    source

   1          #include "timer.h"
   2          #include "global.h"
   3          #include "led.h"
   4          #include "touch.h"
   5          /*
   6          //时钟周期 22.1184MHz
   7          1秒的机器周期为 22118400
   8          1ms的需要的机器周期为 22118.4
   9          
  10          22118.4/12 = 1843.2(0x0733)
  11          
  12          65536 - 22118 = 43418（0xA99A）
  13          
  14          65536 - 1843 = 43418（0xF8CD）
  15          
  16          
  17          
  18          */
  19          
  20          
  21          extern KEY_INFO_Typedef key_info;
  22          
  23          extern LED_BLINK_Typedef led_blink_info;
  24          
  25          
  26          
  27          void TIMER0_initialize(void)  //Initialize TIMER0
  28          {
  29   1          IEN0 |= (ET2<<5)|(ET1<<3)|(ET0<<1); //IE=IEN0
  30   1          TMOD  = d_T0MOD;
  31   1          TH0   = d_T0_TH0;  //MODE1 16bit
  32   1          TL0   = d_T0_TL0;
  33   1      }
  34          
  35          
  36          void Start_Timer0(void)
  37          {
  38   1          TIMER0_initialize();
  39   1          
  40   1          EA   = 1;
  41   1          TR0  = 1;
  42   1      }
  43          
  44          unsigned char which_key_blink = 0;
  45          unsigned char which_key_blink_off = 0;
  46          void TIMER0_ISR(void) interrupt TIMER0_VECTOR
  47          {
  48   1          // To do something by using timer interrupt.
  49   1          static unsigned char idata times1ms = 1;
  50   1          static unsigned char idata times2ms = 2;
  51   1          static unsigned char idata times10ms = 10;
  52   1          static unsigned int idata times1000ms = 1000;
  53   1        
C51 COMPILER V9.52.0.0   TIMER                                                             12/28/2017 10:57:51 PAGE 2   

  54   1          static unsigned char idata led_control_times_1ms = 0;
  55   1          //static unsigned char idata which_key_blink_off = 0;
  56   1        
  57   1          //static unsigned long test = 0;
  58   1        
  59   1          if(--times1ms == 0)
  60   1          {
  61   2              g_1ms_flag = 1;
  62   2              times1ms = 1;
  63   2            
  64   2              if(key_info.IsCount == 1)
  65   2              {
  66   3                  key_info.count_1ms_times++;
  67   3              } 
  68   2            
  69   2              if(led_blink_info.IsLedBlink == 1)
  70   2              {
  71   3                  led_blink_info.ledcount_1ms_times++;
  72   3                  if(led_blink_info.ledcount_1ms_times == LED_OFF_TIMES)
  73   3                  {
  74   4                      led_blink_info.ledstate = LED_OFF;
  75   4                      which_key_blink_off = which_key_blink;
  76   4                  }
  77   3                  else if(led_blink_info.ledcount_1ms_times == LED_ON_TIMES)
  78   3                  {
  79   4                      led_blink_info.ledstate = LED_ON;
  80   4                      led_blink_info.ledcount_1ms_times = 0;
  81   4                      which_key_blink_off = KEY_NONE;
  82   4                      led_blink_info.blinktimes++;
  83   4                  }      
  84   3              }
  85   2              else
  86   2              {
  87   3                  if(which_key_blink != KEY_NONE)
  88   3                  {
  89   4                      which_key_blink = KEY_NONE;
  90   4                  }
  91   3              
  92   3                  if(which_key_blink_off != KEY_NONE)
  93   3                  {
  94   4                      which_key_blink_off = KEY_NONE;
  95   4                  }        
  96   3              } 
  97   2          
  98   2              if(led_control_times_1ms < 3)
  99   2              {
 100   3                  led_control_times_1ms += 1;  
 101   3              }
 102   2              else 
 103   2              {
 104   3                  led_control_times_1ms = 0;
 105   3              }
 106   2          
 107   2              if(led_control_times_1ms == 1)
 108   2              {
 109   3              
 110   3                  LED_POWER_PIN = 0;
 111   3                  LED_TIMER_PIN = 0;         
 112   3              }
 113   2              else 
 114   2              {       
 115   3                  if(led_control_times_1ms == 2)
C51 COMPILER V9.52.0.0   TIMER                                                             12/28/2017 10:57:51 PAGE 3   

 116   3                  {
 117   4                      if(which_key_blink_off != KEY_POWER)
 118   4                      {
 119   5                          LED_POWER_PIN = 1;
 120   5                      }
 121   4                  
 122   4                      if(which_key_blink_off != KEY_TIMER)
 123   4                      {
 124   5                          LED_TIMER_PIN = 1;
 125   5                      }
 126   4                 
 127   4                      LED_SPEED_PIN = 0;
 128   4                      LED_MODE_PIN = 0;
 129   4                  }
 130   3                  else if(led_control_times_1ms == 3)
 131   3                  {
 132   4                      if(which_key_blink_off != KEY_SPEED)
 133   4                      {
 134   5                          LED_SPEED_PIN = 1;
 135   5                      }
 136   4                  
 137   4                      if(which_key_blink_off != KEY_MODE)
 138   4                      {
 139   5                          LED_MODE_PIN = 1;
 140   5                      }
 141   4                      led_control_times_1ms = 0;         
 142   4                  }
 143   3              }          
 144   2            
 145   2          }
 146   1      
 147   1        
 148   1          if(--times2ms == 0)
 149   1          {
 150   2              g_2ms_flag = 1;
 151   2              times2ms = 2;
 152   2          }
 153   1        
 154   1          if(--times10ms == 0)
 155   1          {
 156   2              g_10ms_flag = 1;
 157   2              times10ms = 10;
 158   2          }
 159   1          
 160   1          if(--times1000ms == 0)
 161   1          {
 162   2              g_1000ms_flag = 1;
 163   2              times1000ms = 1000;
 164   2          }  
 165   1      
 166   1         
 167   1      
 168   1          TH0   = d_T0_TH0;  //MODE1 16bit
 169   1          TL0   = d_T0_TL0;
 170   1          TR0 = 1;
 171   1          
 172   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    272    ----
   CONSTANT SIZE    =   ----    ----
C51 COMPILER V9.52.0.0   TIMER                                                             12/28/2017 10:57:51 PAGE 4   

   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      2    ----
   IDATA SIZE       =      6    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
